<script src="http://cdn.staticfile.org/socket.io/1.3.7/socket.io.js"></script>
<script src="http://cdn.staticfile.org/jquery/2.2.1/jquery.min.js"></script>
<script>

    //分隔符
    var separator = "AND";
    //把target对象设在最外面
    var target = null
    /*
    io.connect():向服务端发起连接请求
    */
    var ChatRoomClient = function() {
        this.userName = null;
        this.socket = io.connect();
        //初始化界面
        this.startup();
        //启动一堆JQuery函数
        this.bindEvent();
    };
    /*    初始化聊天窗口
        broadcast响应函数:用于接收新连接用户的信息
        changeName():弹出输入用户名窗口
        */
    ChatRoomClient.prototype.startup = function() {
        var self = this;
        var xtpl = [
            '<div class="chatroom">',
            '<div class="chatroom-feedback"><a href="https://github.com/barretlee/blogChat" target="_blank">源码</a> | <a href="https://github.com/barretlee/blogChat/issues/new" target="_blank">反馈</a></div>',
            '<div class="chatroom-info"></div>',
            '<ul class="chatroom-tribes">',
            '<li class="chatroom-tribe current" data-id="group">',
            '<span class="name">当前 <strong>0</strong> 人群聊</span>',
            '<span class="count">0</span>',
            '</li>',
            '</ul>',
            '<div class="chatroom-pannels">',
            '<div class="chatroom-pannel-bd">',
            '<div class="chatroom-item current" data-id="group">',
            '</div>',
            '</div>',
            '<div class="chatroom-pannel-ft"><textarea type="text" class="chatroom-input" placeholder="按 Ctrl+Enter 发送"></textarea><span class="chatroom-send-btn">发送</span></div>',
            '</div>',
            '</div>'
        ].join('\n');
        $('html').append(xtpl);
        //broadcast响应函数:用于接收新连接用户的信息
        self.socket.on('broadcast', function(data) {
            //通知新连接用户的信息
            self.addWelcomeLog(data);
        });
        //弹出输入用户名窗口
        self.changeName();
        //启动randomChat响应函数
        self.socket.on('randomChat', function(data) {
            if (data.threeUsers[0] != self.userName && data.threeUsers[1] != self.userName && data.threeUsers[2] != self.userName ){
                for(var i=0;i<data.userJson.length;i++){
                    for(var key in data.userJson[i]){
                        if (key == self.userName){
                            //alert(typeof(key));
                            //在左边消息栏添加li元素聊天对象，右边聊天框添加div，并把该li和div设为当前对象
                            return self.createPrivateChat(data.userJson[i][key],true);
                        }
                        if (data.userJson[i][key] ==self.userName){
                            return self.createPrivateChat(key,true);
                        }
                    }
                }
            }
            else{
                //alert('start');
                if (data.threeUsers[0] == self.userName){
                    target = data.threeUsers[1]+ separator  +data.threeUsers[2];
                    //alert(target);
                    return self.createPrivateChat(target,true);
                }
                if (data.threeUsers[1] == self.userName){
                    target = data.threeUsers[0]+ separator +data.threeUsers[2];
                    return self.createPrivateChat(target,true);
                }
                if (data.threeUsers[2] == self.userName){
                    target = data.threeUsers[0]+ separator +data.threeUsers[1];
                    return self.createPrivateChat(target,true);
                }
                //alert(data.threeUsers);
            }
        });
        //启动pm响应函数，用于接收服务端的私聊信息
        self.socket.on('pm', function(data) {
            //alert('pm start');
            if (data.targetName.indexOf(separator)){
                var splitArr = data.targetName.split(separator);
                var targetName01 = splitArr[0];
                var targetName02 = splitArr[1];
                var flag = targetName01 == self.userName || targetName02 == self.userName;
                //alert(flag);
                if (flag){
                    data = {
                        msg:data.msg,
                        userName:data.userName,
                        targetName:target
                    }
                    self.addChatLog(data,false);
                    //alert(data.userName);
                }
                //alert(splitArr);
            }
            else{
                if(data.targetName != self.userName) return;
                data = {
                    msg:data.msg,
                    userName:data.userName,
                    targetName:data.userName
                }
                //把对方写的聊天消息添加到聊天框上
                self.addChatLog(data,false);
            }
        })
    }
    //弹出输入用户名窗口
    ChatRoomClient.prototype.changeName = function() {
        var self = this;
        var str = '<div class="chatroom-rename" style="display:none;"><label>取个名字：</label><input type="text" ' +
            'placeholder="请取英文名字！"><span>确认</span></div>';
        $(str).appendTo($('.chatroom')).fadeIn();
        $('.chatroom-rename span').on('click', function() {
            var $input = $('.chatroom-rename input');
            if($.trim($input.val())) {
                self.userName = $.trim($input.val()).slice(0, 12);
                self.socket.emit('createUser', {
                    userName: self.userName
                });
                $('.chatroom-rename').remove();
            }
        });
    };
    //通知新连接用户的信息
    ChatRoomClient.prototype.addWelcomeLog = function(data) {
        var $info = '<div class="chatroom-log-info chatroom-log-welcome"> '
            + '欢迎 '
            + '<strong class="name">' + data.userName + '</strong> 加入群聊！</div>';
        var $target = $(".chatroom-item[data-id='group']");
        $target.append($info);
    };
    //在chatroom-tribes的左边消息栏上添加<li class="chatroom-tribe" data-id='target'>元素，
    //右边chatroom-pannel-bd的聊天框上添加<div class="chatroom-item" data-id='target'></div>元素，
    // 如果setCurrent为true，并把该li和div设为当前对象
    ChatRoomClient.prototype.createPrivateChat = function(target,setCurrent) {
        var tabXtpl = [
            '<li class="chatroom-tribe" data-id='+target+'>',
            '<span class="name">'+target,
            '</span>',
            '<span class="count">0</span>',
            '<i class="iconfont">╳</i>',
            '</li>'
        ];
        //把tabXtpl数组的元素连起来组成一个字符串，并往左边消息栏添加新的li元素（data-id='target'）
        var $li = tabXtpl.join('');
        $(".chatroom-tribes").append($li);
        //把一个新的div（data-id='target'）添加进chatroom-pannel-bd里
        var $pannel = '<div class="chatroom-item" data-id=' + target + '></div>';
        $(".chatroom-pannel-bd").append($pannel);
        //把新建的li元素和div设为当前对象
        if(setCurrent) {
            $('.chatroom-tribe').removeClass('current');
            $('.chatroom-item').removeClass('current');
            $('.chatroom-tribes>li').last().addClass('current');
            $('.chatroom-item').last().addClass('current');
        }
    }
    //在chatroom-item[data-id=' data.targetName']的div上添加聊天信息
        ChatRoomClient.prototype.addChatLog = function(data,isSelf) {
/*        if(!isSelf) {
            data.name = '我';
        }*/
        var logXtpl = [
            '<div class="chatroom-log' + (isSelf ? ' myself' : '') + '">',
            '<span class="time"><b data-id='+data.userName+'>'+data.userName+'</b> ' + new Date().toLocaleString() + '</span>',
            '<span class="detail">'+data.msg+'</span>',
            '</div>'
        ];
        var $log = logXtpl.join('\n');
        var $target = $(".chatroom-item[data-id='" + data.targetName + "']");
        $target.append($log);
    };
    //一堆JQuery函数
    ChatRoomClient.prototype.bindEvent = function() {
        var self = this;
        $('.chatroom-input').on('keydown', function(evt) {
            var $this = $(this);
            if((evt.ctrlKey || evt.metaKey) && evt.keyCode == '13' && $.trim($this.val()) || evt.isTrigger) {
                var targetName = $('.chatroom-tribe.current').attr('data-id');
                var val = $this.val();
                if(val.length >= 516) {
                    val = val.slice(0, 500) + '...(输入太长，系统自动截断)';
                }
                var data = {
                    msg: val,
                    userName: self.userName,
                    targetName: targetName
                };
                //alert("keydown:"+targetName);
                self.socket.emit(targetName == 'group' ? 'gm' : 'pm', data);
                //把自己写的聊天消息添加到自己的聊天框上
                self.addChatLog(data,true);
                $this.val('').focus();
                return false;
            }
        });
    }

    window.chatRoomClient = new ChatRoomClient();
</script>

<style>
    * {
        margin: 0;
        padding: 0;
    }
    body {
        font-size: 12px;
    }
    .chatroom-feedback {
        position: absolute;
        bottom: 3px;
        background: #EEE;
        width: 159px;
        height: 30px;
        line-height: 30px;
        text-align: center;
        z-index: 0;
    }
    .chatroom {
        font-size: 12px;
        position: fixed;
        right: -3px;
        bottom: -3px;
        width: 563px;
        height: 405px;
        z-index: 998;
        overflow: hidden;
        background: #FFF;
        box-shadow: -3px -2px 8px -1px rgba(0,0,0,0.2);
        border-radius: 2px 0px 0px 2px;
        transition: all 0.3s;
    }
    .chatroom-fold {
        right: -404px;
        bottom: -368px;
        transition: all 0.3s;
    }
    .chatroom-fold .chatroom-tribe .count {
        right: 42px;
    }
    .chatroom-info {
        position: absolute;
        right: 10px;
        top: 6px;
        cursor: pointer;
        z-index: 12;
    }
    .chatroom-info:after {
        content: '[收起]';
        color: #F40;
    }
    .chatroom-fold .chatroom-info:after {
        content: '[展开]';
        color: #F40;
        z-index: 10;
        position: relative;
        top: 5px;
    }
    /*没有了chatroom-info的话最小化后会在中间显示*/
    .chatroom-fold .chatroom-info {
        right: 412px;
    }
    .chatroom-tribe {
        -webkit-user-select: none;
        padding: 4px 5px;
        cursor: pointer;
        height: 30px;
        line-height: 30px;
        overflow: hidden;
        margin-bottom: 1px;
        position: relative;
    }
    .chatroom-tribe:hover, .chatroom-tribe.current {
        background: #f2f2f5;
    }
    .chatroom-tribe img {
        width: 30px;
        height: 30px;
        vertical-align: middle;
    }
    .chatroom-tribe .name {
        max-width: 90px;
        display: inline-block;
        vertical-align: middle;
        height: 30px;
        margin-left: 10px;
        line-height: 30px;
        overflow: hidden;
    }
    .chatroom-tribe .count {
        visibility: hidden;
        min-width: 18px;
        height: 13px;
        line-height: 14px;
        text-align: center;
        display: inline-block;
        vertical-align: middle;
        padding: 1px 2px;
        background: #fa7d3c;
        color: #fff;
        border-radius: 3px;
        transform: scale(0.8);
        position: absolute;
        right: 22px;
        top: 12px;
    }
    .chatroom-tribe .iconfont {
        position: absolute;
        right: 0;
        width: 30px;
        height: 30px;
        text-align: center;
        font-size: 12px;
        font-family: Arial;
        color: #696e78;
        font-style: normal;
        transform: scale(0.5);
        font-weight: bold;
        visibility: hidden;
    }
    .chatroom-tribe .iconfont:hover {
        color: #fa7d3c;
    }
    .chatroom-tribe:hover .iconfont {
        visibility: visible;
    }
    .chatroom-tribes {
        float: left;
        width: 159px;
        border-right: 1px #d9d9d9 solid;
        overflow: hidden;
        height: 402px;
        overflow-y: auto;
    }
    .chatroom-tribe {
    }
    .chatroom-pannels {
        float: left;
        width: 400px;
        height: 350px;
    }
    .chatroom-pannel-bd {
        height: 340px;
        background: #f2f2f5;
        overflow-y: auto;
    }
    .chatroom-item {
        display: none;
        padding-bottom: 10px;
    }
    .chatroom-item.current {
        display: block;
    }
    .chatroom-pannel-ft {
        border-top: 1px #d9d9d9 solid;
        position: relative;
        height: 60px;
    }
    .chatroom-pannel-ft textarea {
        resize: none;
        border: none;
        position: absolute;
        left: 6px;
        right: 6px;
        top: 6px;
        width: 77%;
        bottom: 6px;
        outline: none;
        line-height: 18px;
        font-size: 12px;
        overflow-y: auto;
    }
    .chatroom-log {
        padding: 25px 10px 0;
        overflow: hidden;
        line-height: 18px;
    }
    .chatroom-log .avatar {
        width: 30px;
        height: 30px;
        overflow: hidden;
        float: left;
        border-radius: 4px;
        cursor: pointer;
    }
    .chatroom-log .avatar img {
        width: 30px;
        min-height: 30px;
    }
    .chatroom-log .time {
        width: 310px;
        margin-left: 13px;
        margin-bottom: 4px;
        float: left;
        color: #999;
    }
    .chatroom-log .time b {
        text-decoration: underline;
        font-weight: normal;
    }
    .chatroom-log .time b:hover {
        cursor: pointer;
        color: #666;
    }
    .chatroom-log .detail {
        max-width: 222px;
        float: left;
        padding: 5px 9px;
        position: relative;
        margin-left: 13px;
        background: #fff;
        border: 1px #ccc solid;
        border-radius: 5px;
        box-shadow: 0 3px 3px rgba(0,0,0,.05);
        word-break: break-word;
    }
    .chatroom-log .detail:before, .chatroom-log .detail:after {
        content: " ";
        display: inline-block;
        width: 0;
        height: 0;
        border-width: 7px;
        border-style: solid;
        overflow: hidden;
        font-size: 0;
        line-height: 0;
        vertical-align: top;
        top: 10px;
        position: absolute;
        border-top-color: rgba(0, 0, 0, 0);
        border-bottom-color: rgba(0, 0, 0, 0);
        border-left-color: rgba(0, 0, 0, 0);
    }
    .chatroom-log .detail:before {
        border-width: 4px;
        border-top-color: #ccc;
        color: #ccc;
        left: -8px;
    }
    .chatroom-log .detail:after {
        border-top-color: #fff;
        color: #fff;
        left: -6px;
        border-width: 3px;
        top: 11px;
    }
    .chatroom-log.myself {
    }
    .chatroom-log.myself .avatar {
        float: right;
    }
    .chatroom-log.myself .time {
        float: right;
        margin-left: 0;
        margin-right: 13px;
        text-align: right;
    }
    .chatroom-log.myself .detail {
        float: right;
        margin-left: 0;
        margin-right: 13px;
        background: #d7ebfe;
        border: 1px #b7d4ef solid;
    }
    .myself .detail:before, .myself .detail:after {
        border-top-color: rgba(0, 0, 0, 0);
        border-bottom-color: rgba(0, 0, 0, 0);
        border-right-color: rgba(0, 0, 0, 0);
    }
    .chatroom-log.myself .detail:before {
        border-top-color: #b7d4ef;
        border-left-color: #b7d4ef;
        left: auto;
        right: -8px;
    }
    .chatroom-log.myself .detail:after {
        border-top-color: #d7ebfe;
        border-left-color: #d7ebfe;
        left: auto;
        right: -6px;
    }
    .chatroom-log-info {
        text-align: center;
        padding: 5px;
        color: #999;
    }
    .chatroom-rename {
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        background: rgba(0,0,0,0.5);
    }
    .chatroom-rename span {
        cursor: pointer;
        top: 50%;
        margin-top: -15px;
        position: absolute;
        left: 420px;
        background: #EEE;
        height: 30px;
        line-height: 30px;
        padding: 0 15px;
        border-radius: 2px;
        text-align: center;
    }
    .chatroom-rename span:hover {
        background: #ccc;
    }
    .chatroom-rename input {
        position: absolute;
        left: 150px;
        top: 50%;
        height: 30px;
        line-height: 30px;
        text-indent: 10px;
        border: none;
        width: 250px;
        border-radius: 3px;
        margin-top: -15px;
        outline: none;
    }
    .chatroom-rename label {
        position: absolute;
        top: 50%;
        margin-top: -15px;
        line-height: 30px;
        left: 70px;
        color: #FFF;
        font-size: 14px;
    }
    .chatroom-fold .chatroom-rename {
        display: none !important;
    }
    .chatroom-log-welcome {
        padding-left: 20px;
        padding-right: 20px;
    }
    .chatroom-log-welcome img {
        width: 28px;
        vertical-align: middle;
        margin: 0 2px;
        border-radius: 100%;
        cursor: pointer;
    }
    .chatroom-log-welcome strong {
        font-weight: normal;
        cursor:pointer;
        text-decoration: underline;
    }
    .chatroom-send-btn {
        position: relative;
        z-index: 0;
        float: right;
        width: 70px;
        height: 40px;
        background: #EEE;
        text-align: center;
        line-height: 40px;
        top: 10px;
        font-size: 14px;
        margin-right: 10px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .chatroom-send-btn:hover {
        background: #CCC;
        transition: all 0.3s;
    }
</style>
